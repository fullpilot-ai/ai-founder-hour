{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 7, "column": 0}, "map": {"version":3,"file":"SanityLiveStream.js","sources":["file:///Users/brandonhhays/founderhour/ai-founder-hour/node_modules/%40sanity/next-loader/src/client-components/live-stream/SanityLiveStream.tsx"],"sourcesContent":["import {\n  type ClientPerspective,\n  type ContentSourceMap,\n  type InitializedClientConfig,\n  type QueryParams,\n} from '@sanity/client'\nimport {stegaEncodeSourceMap} from '@sanity/client/stega'\nimport type {LoaderControllerMsg} from '@sanity/presentation-comlink'\nimport {dequal} from 'dequal/lite'\nimport {useCallback, useEffect, useState, useSyncExternalStore} from 'react'\nimport * as React from 'react'\nimport {useEffectEvent} from 'use-effect-event'\nimport {comlinkListeners, comlink as comlinkSnapshot} from '../../hooks/context'\n\nconst use: typeof React.use =\n  'use' in React\n    ? // @ts-expect-error this is fine\n      React['u' + 's' + 'e']\n    : () => {\n        throw new TypeError('SanityLiveStream requires a React version with React.use()')\n      }\n\n/**\n * @public\n */\nexport interface SanityLiveStreamProps\n  extends Pick<InitializedClientConfig, 'projectId' | 'dataset'> {\n  query: string\n  params?: QueryParams\n  perspective?: Exclude<ClientPerspective, 'raw'>\n  stega?: boolean\n  initial: Promise<React.ReactNode>\n  children: (result: {\n    data: unknown\n    sourceMap: ContentSourceMap | null\n    tags: string[]\n  }) => Promise<React.ReactNode>\n}\n\nconst LISTEN_HEARTBEAT_INTERVAL = 10_000\n\n/**\n * @public\n */\nexport default function SanityLiveStream(props: SanityLiveStreamProps): React.JSX.Element | null {\n  const {query, dataset, params = {}, perspective, projectId, stega} = props\n\n  const subscribe = useCallback((listener: () => void) => {\n    comlinkListeners.add(listener)\n    return () => comlinkListeners.delete(listener)\n  }, [])\n\n  const comlink = useSyncExternalStore(\n    subscribe,\n    () => comlinkSnapshot,\n    () => null,\n  )\n  const [children, setChildren] = useState<React.ReactNode | undefined>(undefined)\n\n  const handleQueryHeartbeat = useEffectEvent((comlink: NonNullable<typeof comlinkSnapshot>) => {\n    comlink.post('loader/query-listen', {\n      projectId: projectId!,\n      dataset: dataset!,\n      perspective: perspective! as ClientPerspective,\n      query,\n      params: params!,\n      heartbeat: LISTEN_HEARTBEAT_INTERVAL,\n    })\n  })\n  const handleQueryChange = useEffectEvent(\n    (event: Extract<LoaderControllerMsg, {type: 'loader/query-change'}>['data']) => {\n      if (\n        dequal(\n          {\n            projectId,\n            dataset,\n            query,\n            params,\n          },\n          {\n            projectId: event.projectId,\n            dataset: event.dataset,\n            query: event.query,\n            params: event.params,\n          },\n        )\n      ) {\n        const {result, resultSourceMap, tags} = event\n        const data = stega\n          ? stegaEncodeSourceMap(result, resultSourceMap, {enabled: true, studioUrl: '/'})\n          : result\n        // eslint-disable-next-line no-console\n        // console.log('server function streaming is disabled', {\n        //   startTransition,\n        //   setPromise,\n        //   data,\n        //   resultSourceMap,\n        //   tags,\n        // })\n        // console.log('rendering with server action')\n        // startTransition(() =>\n        //   setPromise(\n        //     props.children({\n        //       data,\n        //       sourceMap: resultSourceMap!,\n        //       tags: tags || [],\n        //     }) as Promise<React.JSX.Element>,\n        //   ),\n        // )\n        // eslint-disable-next-line no-console\n        console.groupCollapsed('rendering with server action')\n        ;(\n          props.children({\n            data,\n            sourceMap: resultSourceMap!,\n            tags: tags || [],\n          }) as Promise<React.JSX.Element>\n        )\n          .then(\n            (children) => {\n              // eslint-disable-next-line no-console\n              console.log('setChildren(children)')\n              // startTransition(() => setChildren(children))\n              setChildren(children)\n            },\n            (reason: unknown) => {\n              // eslint-disable-next-line no-console\n              console.error('rendering with server action: render children error', reason)\n            },\n          )\n          // eslint-disable-next-line no-console\n          .finally(() => console.groupEnd())\n      }\n    },\n  )\n  useEffect(() => {\n    if (!comlink) return\n\n    const unsubscribe = comlink.on('loader/query-change', handleQueryChange)\n    const interval = setInterval(() => handleQueryHeartbeat(comlink), LISTEN_HEARTBEAT_INTERVAL)\n    return () => {\n      clearInterval(interval)\n      unsubscribe()\n    }\n  }, [comlink])\n\n  if (!comlink || children === undefined) {\n    return use(props.initial) as React.JSX.Element\n  }\n\n  return <>{children}</>\n}\nSanityLiveStream.displayName = 'SanityLiveStream'\n"],"names":["comlink","comlinkSnapshot","children"],"mappings":";;;;;;;;;;;;;;;;AAcA,MAAM,MACJ,SAAS,wMAAA,gCAAA;AAEL,sMAAM,GAAA,GACN,MAAM;IACE,MAAA,IAAI,UAAU,4DAA4D;AAClF,GAmBA,4BAA4B;AAKlC,SAAwB,iBAAiB,KAAA,EAAwD;IACzF,MAAA,EAAC,KAAA,EAAO,OAAA,EAAS,SAAS,CAAI,CAAA,EAAA,WAAA,EAAa,SAAA,EAAW,KAAA,CAAA,CAAA,GAAS,OAE/D,gBAAY,oNAAA,EAAY,CAAC,WAAA,gLAC7B,mBAAA,CAAiB,GAAA,CAAI,QAAQ,GACtB,mLAAM,mBAAA,CAAiB,MAAA,CAAO,QAAQ,CAAA,GAC5C,EAAE,GAECA,sNAAU,uBAAA,EACd,WACA,mLAAMC,UAAAA,EACN,IAAM,OAEF,CAAC,UAAU,WAAW,CAAA,GAAI,qNAAA,EAAsC,KAAA,CAAS,GAEzE,mLAAuB,iBAAA,EAAe,CAACD,aAAiD;QAC5FA,SAAQ,IAAA,CAAK,uBAAuB;YAClC;YACA;YACA;YACA;YACA;YACA,WAAW;QAAA,CACZ;IAAA,CACF,GACK,gLAAoB,iBAAA,EACxB,CAAC,UAA+E;QAE5E,iJAAA,SAAA,EACE;YACE;YACA;YACA;YACA;QACF,GACA;YACE,WAAW,MAAM,SAAA;YACjB,SAAS,MAAM,OAAA;YACf,OAAO,MAAM,KAAA;YACb,QAAQ,MAAM,MAAA;QAAA,IAGlB;YACA,MAAM,EAAC,MAAA,EAAQ,eAAA,EAAiB,IAAA,CAAI,CAAA,GAAI,OAClC,OAAO,gMACT,uBAAA,EAAqB,QAAQ,iBAAiB;gBAAC,SAAS,CAAA;gBAAM,WAAW;YAAI,CAAA,IAC7E;YAoBJ,QAAQ,cAAA,CAAe,8BAA8B,GAEnD,MAAM,QAAA,CAAS;gBACb;gBACA,WAAW;gBACX,MAAM,QAAQ,CAAA,CAAA;YACf,CAAA,EAEA,IAAA,CACC,CAACE,cAAa;gBAEZ,QAAQ,GAAA,CAAI,uBAAuB,GAEnC,YAAYA,SAAQ;YACtB,GACA,CAAC,WAAoB;gBAEX,QAAA,KAAA,CAAM,uDAAuD,MAAM;YAAA,GAI9E,OAAA,CAAQ,IAAM,QAAQ,QAAA,EAAU;QAAA;IACrC;IAcJ,QAXA,qNAAA,EAAU,MAAM;QACd,IAAI,CAACF,UAAS,CAAA;QAEd,MAAM,cAAcA,UAAQ,EAAA,CAAG,uBAAuB,iBAAiB,GACjE,WAAW,YAAY,IAAM,qBAAqBA,SAAO,GAAG,yBAAyB;QAC3F,OAAO,MAAM;YACG,cAAA,QAAQ,GACtB,YAAY;QACd;IACC,GAAA;QAACA,SAAO;KAAC,GAER,CAACA,aAAW,aAAa,KAAA,IACpB,IAAI,MAAM,OAAO,IAAA,aAAA,GAAA,CAAA,GAAA,uNAAA,CAAA,MAAA,EAAA,uNAAA,CAAA,WAAA,EAAA;QAGhB;IAAS,CAAA;AACrB;AACA,iBAAiB,WAAA,GAAc","ignoreList":[0],"debugId":null}}]
}